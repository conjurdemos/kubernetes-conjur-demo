- !group developers

- !group operations

- !policy
  id: test-app-db
  owner: !group operations
  body:
  - &variables
    - !variable password

- !permit
  resources: *variables
  privilege: [ read, execute ]
  role: !layer /test-app

- !policy
  id: conjur/authn-k8s/{{ AUTHENTICATOR_ID }}
  body:
  - !webservice

  - !policy
    id: ca
    body:
    - !variable
      id: cert
      annotations:
        description: CA cert for Kubernetes Pods.

    - !variable
      id: key
      annotations:
        description: CA key for Kubernetes Pods.
  
  - !group clients

  - !permit
    role: !group clients
    privilege: [ read, authenticate ]
    resource: !webservice

  - !policy
    id: apps
    annotations:
      description: Apps and services in the Kubernetes cluster.
    body:
    - !layer

    - &hosts
      - !host
        id: {{ TEST_APP_NAMESPACE_NAME }}/*/*
        annotations:
          kubernetes/authentication-container-name: authenticator
          kubernetes: "true"
      - !host
        id: {{ TEST_APP_NAMESPACE_NAME }}/service_account/test-app-api-sidecar
        annotations:
          kubernetes/authentication-container-name: authenticator
          kubernetes: "true"
      - !host
        id: {{ TEST_APP_NAMESPACE_NAME }}/service_account/test-app-api-init
        annotations:
          kubernetes/authentication-container-name: authenticator
          kubernetes: "true"

    - !grant
      role: !layer
      members: *hosts

  - !grant
    role: !group clients
    member: !layer apps

- !policy
  id: test-app
  owner: !group developers
  body:
  - !layer

- !grant
  role: !layer test-app
  members:
  - !host conjur/authn-k8s/{{ AUTHENTICATOR_ID }}/apps/{{ TEST_APP_NAMESPACE_NAME }}/*/*
  - !host conjur/authn-k8s/{{ AUTHENTICATOR_ID }}/apps/{{ TEST_APP_NAMESPACE_NAME }}/service_account/test-app-api-sidecar
  - !host conjur/authn-k8s/{{ AUTHENTICATOR_ID }}/apps/{{ TEST_APP_NAMESPACE_NAME }}/service_account/test-app-api-init
